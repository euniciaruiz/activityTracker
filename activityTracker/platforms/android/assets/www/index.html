<!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>My Contacts</title> 
            <link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css">
 	        <link type="text/css" href="css/jqm-datebox.min.css" rel="stylesheet">
            <script type="text/javascript" charset="utf-8" src="js/jquery-1.9.1.min.js"></script>
            <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.3.1.min.js"></script>
 			<script type="text/javascript" src="js/jqm-datebox.core.min.js"></script>
 			<script type="text/javascript" src="js/jqm-datebox.mode.calbox.min.js"></script>
 			<script type="text/javascript" src="js/jqm-datebox.mode.datebox.min.js"></script>
 			<script type="text/javascript" src="js/jquery.mobile.datebox.i18n.en_US.utf8.js"></script>
 			<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
            <style>
            .error{
                font-size: 0.8em;
                border: 1px solid;
                margin: 10px 0px;
                padding:15px 10px 15px 8px;
                text-align:center;
                color: #D8000C;
                background-color: #FFBABA;
            }
            </style>
            <script type="text/javascript" charset="utf-8">
             
            $(document).ready(function(){
 
                document.addEventListener("deviceready", onDeviceReady, false);
                 
                var db = window.openDatabase("Database", "1.0", "ActivityTracker", 200000);
 
                function onDeviceReady(){
                    //Populate the database
                    db.transaction(populateDB, errorCB, successCB);
                    //Override the back button functionality
                    document.addEventListener('backbutton', onBack, false);
                }
                 
                function onBack(){
                    //If the current page is index page then exit other wise navigate to index page
                    if($.mobile.activePage.is('#index')){
                        navigator.app.exitApp();
                    }
                    else{
                        db.transaction(queryDB, errorCB);
                    }
                }              
 
                function populateDB(tx){
                    //Create the table
                    tx.executeSql('DROP TABLE IF EXISTS Activity');
                    tx.executeSql('CREATE TABLE IF NOT EXISTS Activity (id INTEGER PRIMARY KEY AUTOINCREMENT, \
                            title TEXT NOT NULL, description TEXT, location TEXT, start_date DATE, \
                            end_date DATE, start_time DATETIME, end_time DATETIME, alert TEXT NOT NULL)\
                             ');
                    tx.executeSql('SELECT id, title, description, location, start_date, end_date, start_time, end_time, alert FROM Activity ORDER BY start_date', [], querySuccess, errorCB);
                }
 
                function successCB(){
                    db.transaction(queryDB, errorCB);
                }
 
                function queryDB(tx){
                    tx.executeSql('SELECT id, title, description, location, start_date, end_date, start_time, end_time, alert FROM Activity ORDER BY start_date', [], querySuccess, errorCB);
                }
 
                function querySuccess(tx, results){
                    $.mobile.showPageLoadingMsg(true);
                    var len = results.rows.length;
                    $("#activityList").html('');
                    for (var i=0; i<len; i++){
                        var row= results.rows.item(i);
                        var htmlData = '<li id="'+row["id"]+'"><a href="#"><h2>'+row["title"]+'</h2><p class="ui-li-aside">'+row["start_date"]+'</p></a></li>';
                        $("#activityList").append(htmlData).listview('refresh');
                    }
                    $.mobile.changePage($("#index"), { transition : "slide"});
                    $.mobile.hidePageLoadingMsg();
                }
 
                function errorCB(err){
 
                }      
             
                $("#addNewPage .error").html('').hide();
 
                $(".addNew").bind ("click", function (event){
                    $("#addNewPage .error").html('').hide();
                    $.mobile.changePage ($("#addNewPage"), { transition : "slide", reverse : true });
                    $("#addNewPageHeader").html("Add New");
                });
 
                $("#save").bind ("click", function (event){
                	var len;
                    var title = $.trim($("#title").val()).replace(/[^A-Za-z0-9 ]/g, '');
                    var description = $.trim($("#description").val());
                    var location = $.trim($("#location").val());
                    var start_date = $.trim($("#start_date").val());
                    var end_date = $.trim($("#end_date").val());
                    var start_time = $.trim($("#start_time").val());
                    var end_time = $.trim($("#end_time").val());
                    var alert = $.trim($("#alert").val());
                    console.log(title+' '+description+' '+location+' '+start_date+' '+end_date+' '+start_time+' '+end_time+' '+alert);

					db.transaction(function (tx){
                    	tx.executeSql("SELECT * FROM Activity WHERE title=?;", [title], function (tx, results){
                        	len = results.rows.length;
                        });
                    });
                    
                    if (title == ''){
                        $("#addNewPage .error").html(bool).show();
                    }
                    else {
	                    if (start_date == ''){
	                        $("#addNewPage .error").html('Please enter the start date of the activity.').show();
	                    }
	                    else if (start_time == ''){
	                        $("#addNewPage .error").html('Please enter the starting time of the activity.').show();
	                    }
	                    else if (end_date == ''){
	                        $("#addNewPage .error").html('Please enter the end date of the activity.').show();
	                    }
	                    else if (end_time == ''){
	                        $("#addNewPage .error").html('Please enter the ending time of the activity.').show();
	                    }
	                    else if (len == 0){
	                    	$("#addNewPage .error").html('Activity already exists.').show();
	                    }
	                    else {
	                    	var currentDate = new Date();
	                    	var currentHour = currentDate.getHours();
	                    
	                    	var startTime = $("#start_time").val();
						    var startHours = Number(startTime.match(/^(\d+)/)[1]);
						    var startAMPM = startTime.match(/\s(.*)$/)[1];
						    if (startAMPM == "PM" && startHours < 12) startHours = startHours + 12;
						    if (startAMPM == "AM" && startHours == 12) startHours = startHours - 12;
						    var startTimeHour = startHours.toString();
						    if (startHours < 10) startTimeHour = "0" + startTimeHour;	    

						    var endTime = $("#end_time").val();
						    var endHours = Number(endTime.match(/^(\d+)/)[1]);
						    var endAMPM = endTime.match(/\s(.*)$/)[1];
						    if (endAMPM == "PM" && endHours < 12) endHours = endHours + 12;
						    if (endAMPM == "AM" && endHours == 12) endHours = endHours - 12;
						    var endTimeHour = endHours.toString();
						    if (endHours < 10) endTimeHour = "0" + endTimeHour;
					
		                    if(start_date === end_date && parseInt(startTimeHour) <= parseInt(currentHour)) {
		                    		$("#addNewPage .error").html('Since the start date is today, the start time must be ahead one hour or more than the current hour').show();
							}
							else if(start_date === end_date && parseInt(startTimeHour) >= parseInt(endTimeHour)) {
		                    		$("#addNewPage .error").html('Since the start date is today, the start time must be less than one hour or more than the current hour').show();
							}
							else if(Date.parse(start_date) > Date.parse(end_date)){
								$("#addNewPage .error").html('Start Date cannot be after End Date.').show();
							}
		                    else{
		                    	if(Date.parse(start_date) < Date.parse(end_date) && parseInt(startTimeHour) <= parseInt(currentHour)) {
		                    		$("#addNewPage .error").html('Since the start date is today, the start time must be ahead one hour or more than the current hour').show();
								}			  	
		                        resetForm();
		 
		                        var id = $("#id").val();
		                        $("#id").val('');
		                        if (id == ''){  //Save
		                            db.transaction(function (tx){ tx.executeSql("INSERT INTO Activity (title, description, location, start_date, end_date, start_time, end_time, alert) VALUES  (?, ?, ?, ?, ?, ?, ?, ?)",[title, description, location, start_date, end_date, start_time, end_time, alert],
		                            queryDB, errorCB); }); 
		                        }
								else{   //Update
		                            db.transaction(function (tx){ tx.executeSql("UPDATE Activity SET title=?, description=?, location=?, start_date=?, end_date=?, start_time=?, end_time=?, alert=?, WHERE id=? ",[title, description, location, start_date, end_date, start_time, end_time, alert],
		                            queryDB, errorCB); }); 
		                        }
		                        
		                        db.transaction(queryDB, errorCB);
		                    }
	                    }
	                }
                    
                });
                 
                $(".refresh").bind("click", function (event){
                    db.transaction(queryDB, errorCB);
                });
                 
                $(".back").bind("click", function (event){
                    resetForm();
                    db.transaction(queryDB, errorCB);
                });
                 
                function resetForm(){
                    $("#addNewPage .error").html('').hide();
                    $("#addNewPage #title").val('');
                    $("#addNewPage #description").val('');
                    $("#addNewPage #location").val('');
                    $("#addNewPage #start_date").val('');
                    $("#addNewPage #end_date").val('');
                    $("#addNewPage #start_time").val('');
                    $("#addNewPage #end_time").val('');
                    $("#addNewPage #alert").val('');
                    $("#addNewPage #addNewPageHeader").html(''); 
                }
                 
                $("#index [data-role='content'] ul").on('tap taphold', 'li', function (event){
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    var liId = this.id;
                    if (event.type === 'taphold'){
                        navigator.notification.vibrate(30);
                        var $popup = $('#actionList-popup');
                        $("#actionList").html('');
                        $("#actionList").append('<li id="edit&'+liId+'">Edit</li>').listview('refresh');
                        $("#actionList").append('<li id="delete&'+liId+'">Delete</li>').listview('refresh');
                        $popup.popup();
                        $popup.popup('open');
                        $("#tapHoldCheck").val('true');
                    }
                    else if (event.type === 'tap'){
                        if ($("#tapHoldCheck").val() == ''){ //If the value of the text box is blank then only tap will work
                            db.transaction(function (tx){
                                //tx.executeSql('SELECT id, title, description, location, start_date, end_date, start_time, end_time, alert FROM Activity ORDER BY start_date', [], querySuccess, errorCB);
                                tx.executeSql("SELECT title, description, location, start_date, end_date, start_time, end_time, alert FROM Activity WHERE id=?;", [liId], function (tx, results){
                                    var row = results.rows.item(0);
                                    $.mobile.showPageLoadingMsg(true);
                                    $.mobile.changePage($("#displayDataPage"), { transition : "slide"});
                                    $("#titleHeader").html(row['title']);
                                    $("#activityTitle").html(row['title']);
                                    $("#activityDescription").html(row['description']);
                                    $("#activityLocation").html(row['location']);
                                    $("#activityStartDate").html(row['start_date']);
                                    $("#activityEndDate").html(row['end_date']);
                                    $("#activityStartTime").html(row['start_time']);
                                    $("#activityEndTime").html(row['end_time']);
                                    $("#activityAlert").html(row['alert']);
                                    $('#dataList').trigger('create');
                                    $('#dataList').listview('refresh');
                                    $.mobile.hidePageLoadingMsg();
                                });
                             });
                        }
                    }
                });
 
                //Change the hidden field value when the popup is closed
                $('#actionList-popup').bind({
                    popupafterclose: function(event, ui){
                        $("#tapHoldCheck").val('');
                    }
                });
 
                $("#index [data-role='popup'] ul").on('click', 'li', function (event){
                    var action_liId = this.id.split('&');
                    var action = action_liId[0];
                    var id = action_liId[1];
                    if (action == 'edit'){
                        db.transaction(function (tx){
                            tx.executeSql("SELECT title, description, location, start_date, end_date, start_time, end_time, alert FROM Activity WHERE id=?;", [id], function (tx, results){
                                var row = results.rows.item(0);
                                $("#title").val(row['title']);
                                $("#description").val(row['description']);
                                $("#location").val(row['location']);
                                $("#start_date").val(row['start_date']);
                                $("#end_date").val(row['end_date']);
                                $("#start_time").val(row['start_time']);
                                $("#end_time").val(row['end_time']);
								$("#alert").val(row['alert']);
                                $("#id").val(id);
                                $("#addNewPageHeader").html('Edit');
                                $.mobile.changePage ($("#addNewPage"), { transition : "slide", reverse : true });
                            });
                         });
                    }
                    if (action == 'delete'){
                        navigator.notification.confirm(
                            'Are you sure?',
                            function(buttonIndex){onConfirm(buttonIndex, id);},
                            'Delete Contact',
                            'Ok, Cancel'
                        );
                    }
                });
                 
                function onConfirm(buttonIndex, id){
                    if (buttonIndex === 1){ //Delete
                        db.transaction(function (tx){ tx.executeSql("DELETE FROM Activity WHERE id=?", [id], queryDB, errorCB); });
                    }
                    if (buttonIndex === 2){
                        $.mobile.changePage($("#index"), { transition : "slide"});
                    }
                }
            });
            
            $(document).on('pageinit', '#index', function(){ 
			    $('#start_date').bind('datebox', function(e, p) {
			        if ( p.method === 'set') {
			             var endDate = $('#start_date').val().replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})$/,'$3-$1-$2');
			            $('#end_date').attr({'min':endDate,'max':'2999-01-01'});
			            $('#end_date').datebox('applyMinMax');
			        }
			    });
			});
            </script>
        </head>
    <body>
 		<!--Home page view -->
        < <div data-role="page" id="index">
            <div data-role="header" data-position="fixed">
                <a href="#" class="refresh" data-role="button" data-icon="refresh" data-theme="a" title="Refresh">Refresh</a>
                <h1>Upcoming Activities</h1>
                <a href="#" class="addNew" data-role="button" data-icon="add" data-theme="a" title="Add New">Add</a>
            </div>
            <div data-role="content">
                <ul data-role="listview" data-filter="true" data-filter-placeholder="Search..." id="activityList">  </ul>
            </div>
            <div data-role="popup" id="actionList-popup" data-overlay-theme="a">
                <ul data-role="listview" id="actionList" style="border: 1px solid blue; width:15em">  </ul>
            </div>
            <input type="hidden" id="tapHoldCheck" value="" />
        </div>
        <!--Home page view end-->

    	<!-- Form Page Start -->

        <div data-role="page" id="addNewPage">
            <div data-role="header" data-position="fixed">
                <a href="#" class="back" data-role="button" data-icon="arrow-l" data-theme="a" title="Back">Back</a>
                <h1 id="addNewPageHeader"></h1>
                <a href="#" id="save" data-role="button" data-icon="check" data-theme="a" title="Save">Save</a>
            </div>
            <div data-role="content">
                <div class='error'></div>
                <div data-role="fieldcontain">
                    <label for="name">Title:</label>
                    <input type="text" name="title" id="title" required="true" maxlength="20" value="" />
                </div>
                <div data-role="fieldcontain">
                    <label for="description">Description:</label>
                    <textarea name="description" id="description" value="" rows="4" cols="50" ></textarea>
                </div>
                <div data-role="fieldcontain">
                    <label for="location">Location:</label>
                    <input type="text" name="location" id="location" value="" />
                </div>
                <div data-role="fieldcontain">
                	<label for="start_date">Start Date</label>
                	<input name="start_date" id="start_date" type="text" data-role="datebox" data-options='{"mode": "calbox", "afterToday": true, "closeCallback": "$(\"#start_time\").datebox(\"open\");"}'/>
                </div>
                <div data-role="fieldcontain">
                    <label for="start_time">Start Time</label>
					<input name="start_time" id="start_time" type="text" value="" data-role="datebox" data-options='{"mode":"timebox", "useNewStyle":true, "useFocus": true , "useButton": false}' />
                </div>
                <div data-role="fieldcontain">
                	<label for="end_date">End Date</label>
            		<input name="end_date" id="end_date" type="date" data-role="datebox" data-options='{"mode": "calbox", "closeCallback": "$(\"#end_time\").datebox(\"open\");"}'/>
                </div>
                <div data-role="fieldcontain">
                    <label for="end_time">End Time:</label>
                    <input name="end_time" id="end_time" type="text" value="" data-role="datebox" data-options='{"mode":"timebox", "useNewStyle":true, "useFocus": true, "useButton": false}' />
                </div>
                <div data-role="fieldcontain">
                    <label for="alert">Alert:</label>
                    <select name="alert" id="alert">
					  <option value="Yes">Yes</option>
					  <option value="No">No</option>
					</select>
                </div>

                <input type="hidden" name="id" id="id" value="" />
            </div>
        </div>
        <!-- Form Page End -->
   
        <!--view for each activity-->
        <div data-role="page" id="displayDataPage">
            <div data-role="header" data-position="fixed">
                <a href="#" class="back" data-role="button" data-icon="arrow-l" data-theme="a" title="Back">Back</a>
                <h1 id="nameHeader"></h1>
                <a href="#" class="addNew" data-role="button" data-icon="plus" data-theme="a" title="Add New">Add</a>
            </div>
            <div data-role="content">
                <ul data-role="listview" id="dataList">
                    <li>Title : <span id="activityTitle"></span></li>
                    <li>Description : <span id="activityDescription"></span></li>
                    <li>Location : <span id="activityLocation"></span></li>
                    <li>Start Date : <span id="activityStartDate"></span></li>
                    <li>End Date : <span id="activityEndDate"></span></li>
                    <li>Start Time : <span id="activityStartTime"></span></li>
                    <li>End Time : <span id="activityEndTime"></span></li>
                    <li>Alert : <span id="activityAlert"></span></li>
                </ul>
            </div>
        </div>
        <!--view for each activity end-->
    </body>
</html>